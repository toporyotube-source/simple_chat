<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Toporkov's live (бета тест)</title>
    <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
<div class="app">
    <!-- Модальное окно имени -->
    <div class="modal-backdrop" id="nameModal">
        <div class="modal">
            <h2>Добро пожаловать</h2>
            <p>Введите своё имя, чтобы мы запомнили вас на этом устройстве.</p>
            <input id="username" type="text" placeholder="Ваше имя" />
            <button id="saveNameBtn">Продолжить</button>
        </div>
    </div>

    <!-- Сайдбар -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo-circle">M</div>
            <div class="sidebar-title">Toporkov's live (бета тест)</div>
        </div>

        <div class="rooms-title">Комнаты</div>
        <div class="rooms-list" id="roomsList">
            {% for room in rooms %}
            <button class="room-btn{% if loop.first %} active{% endif %}" data-room="{{ room }}">
                <span class="room-name">
                    {% if room == 'general' %}
                        Общий
                    {% elif room == 'games' %}
                        Игры
                    {% elif room == 'random' %}
                        Разное
                    {% else %}
                        {{ room }}
                    {% endif %}
                </span>
            </button>
            {% endfor %}
        </div>

        <!-- Блок выбора аватара -->
        <div class="sidebar-avatar">
            <div class="avatar-preview" id="avatarPreview"></div>
            <label class="avatar-label">
                <span>Выбрать аватар</span>
                <input type="file" id="avatarInput" accept="image/*" />
            </label>
        </div>

        <div class="sidebar-hint">

        </div>
    </div>

    <!-- Основной чат -->
    <div class="chat">
        <div class="chat-header">
            <div class="chat-header-left">
                <div class="chat-title" id="chatTitle">Общий чат</div>
                <div class="chat-subtitle" id="chatSubtitle">Комната: general</div>
            </div>
            <div class="chat-status">
                <span class="status-indicator"></span>
                <span id="onlineCount">0</span> онлайн
            </div>
        </div>

        <div id="messages" class="chat-messages"></div>

        <form id="form" class="chat-input-area">
            <input id="messageInput" autocomplete="off" placeholder="Напишите сообщение..." />
            <button type="submit">➤</button>
        </form>
    </div>
</div>

<script path=null start=null>
    const roomsElements = document.querySelectorAll(".room-btn");
    const messagesDiv = document.getElementById("messages");
    const form = document.getElementById("form");
    const input = document.getElementById("messageInput");
    const usernameInput = document.getElementById("username");
    const nameModal = document.getElementById("nameModal");
    const saveNameBtn = document.getElementById("saveNameBtn");
    const avatarInput = document.getElementById("avatarInput");
    const avatarPreview = document.getElementById("avatarPreview");
    const chatTitle = document.getElementById("chatTitle");
    const chatSubtitle = document.getElementById("chatSubtitle");
    const onlineCountSpan = document.getElementById("onlineCount");

    // Уникальный ID клиента (чтобы отличать свои сообщения от чужих)
function getClientId() {
    let id = localStorage.getItem("chat_client_id");
    if (!id) {
        id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random();
        localStorage.setItem("chat_client_id", id);
    }
    return id;
}  

    const roomTitles = {
        general: "Общий чат",
        games: "Игры",
        random: "Разное"
    };

    // ===== Имя (localStorage + модалка) =====
    function getStoredName() {
        return localStorage.getItem("chat_username") || "";
    }

    function setStoredName(name) {
        localStorage.setItem("chat_username", name);
    }

    function initUsername() {
        const stored = getStoredName();
        if (stored) {
            usernameInput.value = stored;
            nameModal.style.display = "none";
        } else {
            nameModal.style.display = "flex";
        }
    }

    saveNameBtn.addEventListener("click", () => {
        const name = usernameInput.value.trim();
        if (!name) return;
        setStoredName(name);
        nameModal.style.display = "none";
    });

    // ===== Аватар (localStorage) =====
    function getStoredAvatar() {
        return localStorage.getItem("chat_avatar") || "";
    }

    function setStoredAvatar(dataUrl) {
        localStorage.setItem("chat_avatar", dataUrl);
    }

    function initAvatar() {
        const stored = getStoredAvatar();
        if (stored) {
            avatarPreview.style.backgroundImage = `url(${stored})`;
        }
    }

    avatarInput.addEventListener("change", () => {
        const file = avatarInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
            const dataUrl = reader.result;
            setStoredAvatar(dataUrl);
            avatarPreview.style.backgroundImage = `url(${dataUrl})`;
        };
        reader.readAsDataURL(file);
    });

    // ===== WebSocket и чаты =====
    let currentRoom = "general";
    let ws = null;

    function connect(room) {
        const wsProtocol = (location.protocol === "https:") ? "wss" : "ws";
        ws = new WebSocket(`${wsProtocol}://${location.host}/ws/${room}`);

        ws.onmessage = function (event) {
            const data = JSON.parse(event.data);

            if (data.type === "status") {
                if (data.room === currentRoom) {
                    onlineCountSpan.textContent = data.online;
                }
                return;
            }

            if (data.type === "message") {
    if (data.room !== currentRoom) return;

    // гарантируем, что username — СТРОКА
    let username = data && data.username;
    if (typeof username !== "string") {
        username = "Аноним";
    } else {
        username = username.trim() || "Аноним";
    }

    const isOwn = data.clientId && data.clientId === getClientId();

    const row = document.createElement("div");
    row.className = "message-row " + (isOwn ? "own" : "foreign");

    const avatarDiv = document.createElement("div");
    avatarDiv.className = "message-avatar";

    const initial = username.charAt(0).toUpperCase();

    if (isOwn) {
        const storedAvatar = getStoredAvatar();
        if (storedAvatar) {
            avatarDiv.style.backgroundImage = `url(${storedAvatar})`;
            avatarDiv.textContent = "";
        } else {
            avatarDiv.textContent = initial;
        }
    } else {
        avatarDiv.textContent = initial;
    }

    const bubble = document.createElement("div");
    bubble.className = "message-bubble";

    const header = document.createElement("div");
    header.className = "message-header";
    header.textContent = username;

    const text = document.createElement("div");
    text.className = "message-text";
    text.textContent = data.text || "";

    const meta = document.createElement("div");
    meta.className = "message-meta";
    meta.textContent = data.time || "";

    bubble.appendChild(header);
    bubble.appendChild(text);
    bubble.appendChild(meta);

    row.appendChild(avatarDiv);
    row.appendChild(bubble);
    messagesDiv.appendChild(row);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
            
        };
    }

    function changeRoom(room) {
        currentRoom = room;
        messagesDiv.innerHTML = "";

        chatTitle.textContent = roomTitles[room] || "Чат";
        chatSubtitle.textContent = `Комната: ${room}`;

        roomsElements.forEach(btn => {
            if (btn.dataset.room === room) {
                btn.classList.add("active");
            } else {
                btn.classList.remove("active");
            }
        });

        if (ws) {
            ws.close();
        }
        connect(room);
    }

    roomsElements.forEach(btn => {
        btn.addEventListener("click", () => {
            const room = btn.dataset.room;
            if (room !== currentRoom) {
                changeRoom(room);
            }
        });
    });

    form.addEventListener("submit", function (e) {
        e.preventDefault();
        const text = input.value.trim();
        if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;

        const payload = {
            username: username,
            text: text,
            clientId: getClientId()
};
ws.send(JSON.stringify(payload));
        input.value = "";
    });

    // старт
    initUsername();
    initAvatar();
    connect(currentRoom);
</script>
</body>
</html>